{% extends 'core/base.html' %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-9">
            
            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-header bg-primary text-white py-3 d-flex justify-content-between align-items-center rounded-top-4">
                    <h5 class="mb-0 fw-bold"><i class="fas fa-file-invoice me-2"></i>สร้างใบเสนอราคาใหม่ (Step 1)</h5>
                </div>
                
                <div class="card-body p-4">
                    <form method="post">
                        {% csrf_token %}

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">วันที่เอกสาร</label>
                                {{ form.date }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">ยืนยันราคาถึงวันที่</label>
                                {{ form.valid_until }}
                            </div>
                        </div>

                        <hr class="text-muted opacity-25">

                        <div class="mb-4 p-3 bg-light rounded-3 border border-primary-subtle">
                            <label class="form-label fw-bold text-primary mb-2">
                                <i class="fas fa-search me-1"></i> ค้นหาลูกค้าเก่า (ดึงข้อมูลอัตโนมัติ)
                            </label>
                            <select id="customer_select" class="form-control" style="width: 100%;">
                                <option value="">-- พิมพ์ชื่อลูกค้าเพื่อค้นหา --</option>
                                {% for customer in customers %}
                                <option value="{{ customer.id }}" 
                                        data-name="{{ customer.name }}"
                                        data-tax="{{ customer.tax_id|default:'' }}"
                                        data-phone="{{ customer.phone|default:'' }}" 
                                        data-address="{{ customer.address|default:'' }} {{ customer.sub_district|default:'' }} {{ customer.district|default:'' }} {{ customer.province|default:'' }} {{ customer.zip_code|default:'' }}">
                                      {{ customer.code }} : {{ customer.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="mt-2 text-end">
                                <a href="{% url 'customer_create' %}" target="_blank" class="small fw-bold text-decoration-none text-primary">
                                    <i class="fas fa-plus-circle"></i> เพิ่มลูกค้าใหม่
                                </a>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">ชื่อลูกค้า / บริษัท <span class="text-danger">*</span></label>
                            {{ form.customer_name }}
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">เลขผู้เสียภาษี (ถ้ามี)</label>
                                {{ form.customer_tax_id }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">เบอร์โทรศัพท์</label>
                                {{ form.customer_phone }}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">ที่อยู่</label>
                            {{ form.customer_address }}
                        </div>
                        
                        <div class="mb-4">
                            <label class="form-label fw-bold">หมายเหตุ</label>
                            {{ form.note }}
                        </div>

                        <div class="d-flex justify-content-between pt-3 border-top">
                            <a href="{% url 'quotation_list' %}" class="btn btn-light text-muted fw-bold">ยกเลิก</a>
                            <button type="submit" class="btn btn-success px-5 py-2 shadow fw-bold rounded-pill">
                                <i class="fas fa-save me-2"></i> บันทึกและไปต่อ <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap4-theme@x.x.x/dist/select2-bootstrap4.min.css" rel="stylesheet">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://npmcdn.com/flatpickr/dist/l10n/th.js"></script> <script>
    $(document).ready(function() {
        // --- 1. ตั้งค่าปฏิทิน (Flatpickr) ---
        flatpickr(".datepicker", {
            dateFormat: "d/m/Y",  // ✅ กำหนดรูปแบบเป็น วัน/เดือน/ปี
            locale: "th",         // ✅ ใช้ภาษาไทย
            allowInput: true      // พิมพ์เองก็ได้
        });

        // --- 2. ตั้งค่า Select2 ---
        $('#customer_select').select2({ 
            theme: 'bootstrap4', 
            placeholder: "-- พิมพ์ชื่อลูกค้า --", 
            allowClear: true,
            width: '100%'
        });

        // --- 3. ระบบดึงข้อมูลลูกค้า ---
        $('#customer_select').on('change', function () {
            var selected = $(this).find(':selected');
            var val = $(this).val();

            if (!val) {
                $('#id_customer_name').val('');
                $('#id_customer_tax_id').val('');
                $('#id_customer_phone').val('');
                $('#id_customer_address').val('');
                return;
            }
            $('#id_customer_name').val(selected.data('name'));
            $('#id_customer_tax_id').val(selected.data('tax'));
            $('#id_customer_phone').val(selected.data('phone'));
            $('#id_customer_address').val(selected.data('address'));
        });
    });
</script>

<style>
    .select2-container--bootstrap4 .select2-selection--single { height: 38px !important; }
    .select2-container--bootstrap4 .select2-selection--single .select2-selection__rendered { line-height: 36px; padding-left: 12px; }
    /* ปรับแต่งช่องวันที่ให้มีไอคอนปฏิทิน */
    .datepicker {
        background-color: #fff !important; 
        cursor: pointer;
    }
</style>
{% endblock %}