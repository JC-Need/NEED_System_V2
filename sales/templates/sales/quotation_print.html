{% load humanize %}
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>ใบเสนอราคา {{ qt.code }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --primary-dark: #1a1a1a; --border-color: #000; }
        body { font-family: 'Sarabun', sans-serif; background: #525659; color: #000; font-size: 14px; line-height: 1.3; }
        .page { width: 210mm; min-height: 297mm; padding: 15mm; margin: 10mm auto; background: white; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .header-section { padding-bottom: 10px; border-bottom: 2px solid #000; margin-bottom: 15px; }
        .company-title { font-size: 20px; font-weight: 700; color: #000; line-height: 1.1; margin-bottom: 2px; }
        .company-subtitle { font-size: 13px; color: #555; font-weight: 500; margin-bottom: 4px; }
        .company-details { font-size: 13px; color: #333; line-height: 1.4; }
        .doc-title { font-size: 28px; font-weight: 700; color: var(--primary-dark); text-align: right; line-height: 1; margin-top: 5px; }
        .doc-subtitle { font-size: 11px; color: #777; text-align: right; letter-spacing: 2px; text-transform: uppercase; font-weight: 600; margin-bottom: 8px; }
        .doc-no-group { text-align: right; margin-top: 5px; }
        .doc-no-label { font-size: 10px; color: #666; font-weight: 600; text-transform: uppercase; }
        .doc-no-value { font-size: 16px; font-weight: 700; color: #000; }
        .customer-divider { border-top: 1px solid #000; margin: 12px 0; opacity: 1; }
        .info-group-label { font-size: 11px; color: #666; font-weight: 700; text-transform: uppercase; margin-bottom: 4px; }
        .customer-name { font-size: 16px; font-weight: 700; color: #000; margin-bottom: 2px; }
        .customer-addr { font-size: 14px; line-height: 1.3; margin-bottom: 4px; }
        .ref-table { width: 100%; }
        .ref-table td { padding: 1px 0; font-size: 13px; vertical-align: top; }
        .ref-label { color: #555; width: 90px; font-weight: 500; }
        .ref-value { font-weight: 600; text-align: right; color: #000; }
        .premium-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        .premium-table th { background-color: #f4f4f4; color: #000; font-weight: 700; text-transform: uppercase; font-size: 12px; padding: 8px; border-top: 1px solid #000; border-bottom: 1px solid #000; text-align: center; }
        .premium-table td { padding: 6px 8px; border-bottom: 1px solid #eee; vertical-align: top; font-size: 13px; }
        .total-table { width: 100%; }
        .total-table td { padding: 3px 0; }
        .total-label { text-align: right; padding-right: 15px; color: #555; font-size: 13px; }
        .total-value { text-align: right; font-weight: 600; width: 120px; font-size: 14px; }
        .grand-total-row td { padding-top: 8px; padding-bottom: 8px; font-size: 18px; font-weight: 700; color: #000; }
        .payment-box { font-size: 13px; line-height: 1.4; color: #333; }
        .note-box { font-size: 12px; color: #555; margin-top: 10px; line-height: 1.3; }
        
        /* Layout ลายเซ็นต์ 3 ช่อง */
        .signature-section { margin-top: 40px; }
        .sig-box { text-align: center; position: relative; height: 140px; }
        .sig-line { border-bottom: 1px dotted #000; width: 80%; margin: 0 auto 5px; position: absolute; bottom: 50px; left: 0; right: 0; }
        .sig-role { font-size: 12px; font-weight: 700; position: absolute; bottom: 30px; left: 0; right: 0; }
        .sig-name { font-size: 11px; position: absolute; bottom: 15px; left: 0; right: 0; }
        .sig-date { font-size: 10px; color: #666; position: absolute; bottom: 0; left: 0; right: 0; }
        .sig-img { position: absolute; bottom: 55px; left: 0; right: 0; margin: auto; height: 50px; width: auto; object-fit: contain; }
        .seal-img { position: absolute; bottom: 40px; right: 20px; width: 100px; opacity: 0.8; transform: rotate(-10deg); pointer-events: none; z-index: 10; }

        @media print {
            body { background: white; margin: 0; }
            .page { width: 100%; margin: 0; padding: 10mm; box-shadow: none; border: none; }
            .no-print { display: none !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
    </style>
</head>
<body>
    <div class="text-center py-3 no-print sticky-top" style="background: rgba(50,50,50,0.8); backdrop-filter: blur(5px);">
        <button onclick="window.print()" class="btn btn-light fw-bold shadow-sm rounded-pill px-4 me-2"><i class="fas fa-print me-2"></i> พิมพ์เอกสาร</button>
        <button onclick="window.close()" class="btn btn-outline-light fw-bold shadow-sm rounded-pill px-4">ปิดหน้าต่าง</button>
    </div>

    <div class="page">
        <div class="header-section">
            <div class="row align-items-start">
                <div class="col-7">
                    <div class="d-flex align-items-center mb-2">
                        {% if company.logo %} <img src="{{ company.logo.url }}" style="height: 55px; margin-right: 12px;" alt="Logo"> {% endif %}
                        <div>
                            <div class="company-title">{{ company.name_th|default:"บริษัท นีด ช็อปปิ้ง จำกัด" }}</div>
                            <div class="company-subtitle">{{ company.name_en|default:"NEED SHOPPING CO., LTD." }}</div>
                        </div>
                    </div>
                    <div class="company-details ps-1">
                        {{ company.address|default:"10/10 หมู่ 10 ตำบลบางพระ อำเภอศรีราชา จังหวัดชลบุรี 20110" }}<br>
                        <strong>โทร:</strong> {{ company.phone|default:"033 166 699" }} &nbsp;|&nbsp;
                        <strong>เลขผู้เสียภาษี:</strong> {{ company.tax_id|default:"0205563029342" }}
                    </div>
                </div>
                <div class="col-5">
                    <div class="doc-title">ใบเสนอราคา</div>
                    <div class="doc-subtitle">QUOTATION</div>
                    <div class="doc-no-group mt-3">
                        <div class="doc-no-label">เลขที่เอกสาร / QUOTATION NO.</div>
                        <div class="doc-no-value">{{ qt.code }}</div>
                    </div>
                </div>
            </div>
            <div class="customer-divider"></div>
            <div class="row">
                <div class="col-7 pe-4 border-end border-secondary">
                    <div class="info-group-label"><i class="fas fa-address-book me-1"></i> ลูกค้า / CUSTOMER</div>
                    <div class="customer-name">{{ qt.customer_name }}</div>
                    <div class="customer-addr">{{ qt.customer_address|default:"-" }}</div>
                    <div class="customer-meta mt-1">
                        <strong>โทร:</strong> {{ qt.customer_phone|default:"-" }} &nbsp;&nbsp;
                        <strong>เลขผู้เสียภาษี:</strong> {{ qt.customer_tax_id|default:"-" }}
                    </div>
                </div>
                <div class="col-5 ps-4">
                    <div class="info-group-label">ข้อมูลอ้างอิง / REFERENCE</div>
                    <table class="ref-table">
                        <tr><td class="ref-label">รหัสลูกค้า:</td><td class="ref-value">{{ qt.customer_code|default:"Walk-in" }}</td></tr>
                        <tr><td class="ref-label">วันที่:</td><td class="ref-value">{{ qt.date|date:"d/m/Y" }}</td></tr>
                        <tr><td class="ref-label">ยืนยันราคาถึง:</td><td class="ref-value">{{ qt.valid_until|date:"d/m/Y" }}</td></tr>
                        <tr><td class="ref-label">พนักงานขาย:</td><td class="ref-value">{{ qt.employee.first_name|default:"-" }}</td></tr>
                    </table>
                </div>
            </div>
        </div>

        <div style="min-height: 380px;">
            <table class="premium-table">
                <thead>
                    <tr>
                        <th style="width: 5%;">ลำดับ</th>
                        <th style="width: 50%; text-align: left;">รายการสินค้า / DESCRIPTION</th>
                        <th style="width: 10%;">จำนวน</th>
                        <th style="width: 15%; text-align: right;">ราคาต่อหน่วย</th>
                        <th style="width: 20%; text-align: right;">จำนวนเงิน</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in qt.items.all %}
                    <tr>
                        <td class="text-center text-muted">{{ forloop.counter }}</td>
                        <td>
                            <div class="fw-bold text-dark">{{ item.item_name }}</div>
                            {% if item.description %}<div class="small text-muted" style="font-size: 11px;">{{ item.description }}</div>{% endif %}
                        </td>
                        <td class="text-center fw-bold">{{ item.quantity }}</td>
                        <td class="text-end">{{ item.unit_price|floatformat:2|intcomma }}</td>
                        <td class="text-end fw-bold">{{ item.amount|floatformat:2|intcomma }}</td>
                    </tr>
                    {% endfor %}
                    {% for i in "1234" %}<tr><td colspan="5" style="height: 25px;"></td></tr>{% endfor %}
                </tbody>
            </table>
        </div>

        <div class="row">
            <div class="col-7 pe-5">
                <div class="py-2 px-3 mb-3 bg-light border text-center fw-bold text-dark rounded" style="font-size: 14px;">( <span id="baht-text">...</span> )</div>
                <div class="payment-box mb-3">
                    <div class="fw-bold mb-1" style="font-size: 12px; text-transform: uppercase;">ข้อมูลการชำระเงิน (Payment Details):</div>
                    <div class="ps-2 border-start border-3 border-dark">
                        ธนาคาร: <strong>กสิกรไทย (KBANK)</strong><br>
                        ชื่อบัญชี: <strong>บริษัท นีด ช็อปปิ้ง จำกัด</strong><br>
                        เลขบัญชี: <strong>075-3-824782</strong>
                    </div>
                </div>
                <div class="note-box"><strong>หมายเหตุ:</strong> {{ qt.note|default:"-ชำระเงินมัดจำ 50% ของยอดรวมเพื่อยืนยันการสั่งซื้อ ส่วนที่เหลือชำระก่อนการจัดส่ง"|linebreaksbr }}</div>
            </div>
            <div class="col-5">
                <table class="total-table">
                    <tr><td class="total-label">รวมราคาสินค้า</td><td class="total-value">{{ item_total|floatformat:2|intcomma }}</td></tr>
                    {% if qt.discount > 0 %}<tr><td class="total-label text-danger">หักส่วนลด</td><td class="total-value text-danger">-{{ qt.discount|floatformat:2|intcomma }}</td></tr>{% endif %}
                    {% if qt.shipping_cost > 0 %}<tr><td class="total-label">ค่าขนส่ง</td><td class="total-value">{{ qt.shipping_cost|floatformat:2|intcomma }}</td></tr>{% endif %}
                    <tr><td class="total-label">ราคาก่อนภาษี</td><td class="total-value">{{ qt.subtotal|floatformat:2|intcomma }}</td></tr>
                    <tr><td class="total-label">VAT 7%</td><td class="total-value">{{ qt.tax_amount|floatformat:2|intcomma }}</td></tr>
                    <tr class="grand-total-row"><td class="total-label" style="border-top: 1px solid #000; padding-top: 10px;">ยอดรวมสุทธิ</td><td class="total-value" style="border-top: 1px solid #000; padding-top: 10px;">{{ qt.grand_total|floatformat:2|intcomma }}</td></tr>
                    <tr><td></td><td><div style="border-bottom: 3px double #000; margin-top: 2px;"></div></td></tr>
                </table>
            </div>
        </div>

        <div class="row signature-section">
            
            <div class="col-4">
                <div class="sig-box">
                    <div class="sig-line"></div>
                    <div class="sig-role">ผู้สั่งซื้อ (Buyer)</div>
                    <div class="sig-name">................................................</div>
                    <div class="sig-date">วันที่ ........./........./.............</div>
                </div>
            </div>

            <div class="col-4">
                <div class="sig-box">
                    {% if qt.employee and qt.employee.signature %}
                        <img src="{{ qt.employee.signature.url }}" class="sig-img">
                    {% endif %}
                    <div class="sig-line"></div>
                    <div class="sig-role">ผู้จัดทำ (Prepared By)</div>
                    <div class="sig-name">({{ qt.employee.first_name }} {{ qt.employee.last_name }})</div>
                    <div class="sig-date">วันที่ {{ qt.created_at|date:"d/m/Y" }}</div>
                </div>
            </div>

            <div class="col-4 position-relative">
                <div class="sig-box">
                    {% if qt.status == 'APPROVED' and company.seal %}
                        <img src="{{ company.seal.url }}" class="seal-img"> {% endif %}

                    {% if qt.status == 'APPROVED' and qt.approved_by and qt.approved_by.signature %}
                        <img src="{{ qt.approved_by.signature.url }}" class="sig-img">
                    {% endif %}
                    
                    <div class="sig-line"></div>
                    <div class="sig-role">ผู้อนุมัติ (Authorized By)</div>
                    
                    {% if qt.status == 'APPROVED' %}
                        <div class="sig-name">({{ qt.approved_by.first_name }} {{ qt.approved_by.last_name }})</div>
                        <div class="sig-date">วันที่ {{ qt.approved_at|date:"d/m/Y" }}</div>
                    {% else %}
                        <div class="sig-name">(................................................)</div>
                        <div class="sig-date">(รอการอนุมัติ)</div>
                    {% endif %}
                </div>
            </div>

        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const num = {{ qt.grand_total }};
            document.getElementById('baht-text').innerText = ThaiBaht(num);
        });
        function ThaiBaht(number) {
            const num = parseFloat(number).toFixed(2);
            if (parseFloat(num) === 0) return "ศูนย์บาทถ้วน";
            const bahtText = ["ศูนย์", "หนึ่ง", "สอง", "สาม", "สี่", "ห้า", "หก", "เจ็ด", "แปด", "เก้า"];
            const unitText = ["", "สิบ", "ร้อย", "พัน", "หมื่น", "แสน", "ล้าน"];
            let [integer, fraction] = num.split(".");
            let text = "";
            for (let i = 0; i < integer.length; i++) {
                let digit = parseInt(integer.charAt(i));
                let unit = unitText[(integer.length - 1 - i) % 7];
                if (digit !== 0) {
                    if (i === integer.length - 1 && digit === 1 && integer.length > 1) text += "เอ็ด";
                    else if (i === integer.length - 2 && digit === 2) text += "ยี่";
                    else if (i === integer.length - 2 && digit === 1) text += "";
                    else text += bahtText[digit];
                    text += unit;
                }
            }
            text += "บาท";
            if (parseInt(fraction) === 0) text += "ถ้วน";
            else {
                if (fraction.length === 2) {
                    let d1 = parseInt(fraction.charAt(0)), d2 = parseInt(fraction.charAt(1));
                    if (d1 !== 0) { if (d1 === 1) text += ""; else if (d1 === 2) text += "ยี่"; else text += bahtText[d1]; text += "สิบ"; }
                    if (d2 !== 0) { if (d2 === 1 && d1 !== 0) text += "เอ็ด"; else text += bahtText[d2]; }
                    text += "สตางค์";
                }
            }
            return text;
        }
    </script>
</body>
</html>