{% extends 'core/base.html' %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://npmcdn.com/flatpickr/dist/l10n/th.js"></script>

<div class="container py-5">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-0 text-dark"><i class="fas fa-user-plus me-2 text-primary"></i>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h2>
            <p class="text-muted">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö One-Stop Service</p>
        </div>
        <a href="{% url 'hr_executive_dashboard' %}" class="btn btn-light rounded-pill border shadow-sm">
            <i class="fas fa-times me-2"></i>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
        </a>
    </div>

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        
        {% if form.errors %}
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô: {{ form.errors }}
            </div>
        {% endif %}

        <div class="row g-4">
            
            <div class="col-lg-4">
                <div class="card border-0 shadow-sm rounded-4 mb-4">
                    <div class="card-body text-center p-4">
                        <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 100px; height: 100px;">
                            <i class="fas fa-camera fa-3x text-secondary opacity-25"></i>
                        </div>
                        <h6 class="fw-bold">‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</h6>
                        <div class="mb-4">{{ form.photo }}</div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4 bg-primary bg-opacity-10">
                    <div class="card-header bg-transparent border-0 pt-3 pb-0">
                        <div class="form-check form-switch">
                            {{ form.create_user_account }}
                            <label class="form-check-label fw-bold text-primary" for="id_create_user_account">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Login)</label>
                        </div>
                    </div>
                    <div class="card-body" id="user-account-section">
                        <div class="mb-2">
                            <label class="small fw-bold text-muted">Username</label>
                            {{ form.username }}
                        </div>
                        <div class="mb-2">
                            <label class="small fw-bold text-muted">Password</label>
                            {{ form.password }}
                        </div>
                        <div class="mb-0">
                            <label class="small fw-bold text-muted">Email</label>
                            {{ form.email }}
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                
                <div class="card border-0 shadow-sm rounded-4 mb-4">
                    <div class="card-header bg-white py-3">
                        <h6 class="fw-bold m-0 text-dark">üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h6>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-3">
                            <div class="col-md-2">
                                <label class="form-label fw-bold">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</label>
                                {{ form.prefix }}
                            </div>
                            <div class="col-md-5">
                                <label class="form-label fw-bold">‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á</label>
                                {{ form.first_name }}
                            </div>
                            <div class="col-md-5">
                                <label class="form-label fw-bold">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                                {{ form.last_name }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</label>
                                {{ form.nickname }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">‡πÄ‡∏û‡∏®</label>
                                {{ form.gender }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</label>
                                {{ form.birth_date }}
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-bold">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                                {{ form.phone }}
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-bold">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label>
                                {{ form.address }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4 mb-4">
                    <div class="card-header bg-white py-3">
                        <h6 class="fw-bold m-0 text-success">üíº ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô</h6>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
                                <div class="input-group">
                                    {{ form.position }}
                                    <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#modalPosition">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">‡πÅ‡∏ú‡∏ô‡∏Å</label>
                                <div class="input-group">
                                    {{ form.department }}
                                    <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#modalDepartment">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                                {{ form.salary }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</label>
                                {{ form.start_date }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4 border-start border-4 border-warning">
                    <div class="card-header bg-warning bg-opacity-10 py-3">
                        <h6 class="fw-bold m-0 text-dark">üå≥ ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡∏° & ‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô</h6>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label fw-bold text-primary">üëë ‡∏ú‡∏π‡πâ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (Upline)</label>
                                {{ form.introducer }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à</label>
                                {{ form.business_rank }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô (%)</label>
                                {{ form.commission_rate }}
                            </div>
                            
                            <div class="col-md-4">
                                <label class="form-label fw-bold">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</label>
                                {{ form.bank_name }}
                            </div>
                            <div class="col-md-8">
                                <label class="form-label fw-bold">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
                                {{ form.bank_account }}
                            </div>
                        </div>

                        <div class="d-grid mt-4">
                            <button type="submit" class="btn btn-primary btn-lg rounded-pill shadow fw-bold">
                                <i class="fas fa-save me-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </form>
</div>

<div class="modal fade" id="modalPosition" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="new_position_title" class="form-control" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="savePosition()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalDepartment" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ú‡∏ô‡∏Å‡πÉ‡∏´‡∏°‡πà</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="new_dept_name" class="form-control" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ú‡∏ô‡∏Å...">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="saveDepartment()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        flatpickr("#id_start_date", { dateFormat: "d/m/Y", locale: "th", allowInput: true });
        flatpickr("#id_birth_date", { dateFormat: "d/m/Y", locale: "th", allowInput: true });
        
        // Toggle User Form
        const toggleUser = document.getElementById('id_create_user_account');
        const userSection = document.getElementById('user-account-section');
        
        function updateToggle() {
            if(toggleUser.checked) {
                userSection.style.display = 'block';
                userSection.querySelectorAll('input').forEach(i => i.required = true);
            } else {
                userSection.style.display = 'none';
                userSection.querySelectorAll('input').forEach(i => i.required = false);
            }
        }
        toggleUser.addEventListener('change', updateToggle);
        updateToggle(); // init
    });

    // AJAX: Save Position
    function savePosition() {
        const title = document.getElementById('new_position_title').value;
        if(!title) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á");

        fetch("{% url 'api_create_position' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: "title=" + encodeURIComponent(title)
        })
        .then(response => response.json())
        .then(data => {
            if(data.status === 'success') {
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ Dropdown
                const select = document.getElementById('id_position');
                const option = new Option(data.title, data.id, true, true);
                select.add(option);
                // ‡∏õ‡∏¥‡∏î Modal
                var myModal = bootstrap.Modal.getInstance(document.getElementById('modalPosition'));
                myModal.hide();
                document.getElementById('new_position_title').value = "";
            }
        });
    }

    // AJAX: Save Department
    function saveDepartment() {
        const name = document.getElementById('new_dept_name').value;
        if(!name) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ú‡∏ô‡∏Å");

        fetch("{% url 'api_create_department' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: "name=" + encodeURIComponent(name)
        })
        .then(response => response.json())
        .then(data => {
            if(data.status === 'success') {
                const select = document.getElementById('id_department');
                const option = new Option(data.name, data.id, true, true);
                select.add(option);
                var myModal = bootstrap.Modal.getInstance(document.getElementById('modalDepartment'));
                myModal.hide();
                document.getElementById('new_dept_name').value = "";
            }
        });
    }
</script>
{% endblock %}