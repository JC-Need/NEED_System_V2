{% extends 'core/base.html' %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<div class="container py-5">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-0 text-dark"><i class="fas fa-user-plus me-2 text-primary"></i>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h2>
            <p class="text-muted">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö One-Stop Service</p>
        </div>
        <a href="{% url 'hr_executive_dashboard' %}" class="btn btn-light rounded-pill border shadow-sm">
            <i class="fas fa-times me-2"></i>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
        </a>
    </div>

    <form method="post" enctype="multipart/form-data" autocomplete="off">
        {% csrf_token %}
        
        {% if form.errors %}
            <div class="alert alert-danger shadow-sm rounded-3">
                <i class="fas fa-exclamation-triangle me-2"></i><strong>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:</strong> ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: {{ form.errors }}
            </div>
        {% endif %}

        <div class="row g-4">
            
            <div class="col-lg-4">
                <div class="card border-0 shadow-sm rounded-4 mb-4">
                    <div class="card-body text-center p-4">
                        <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 100px; height: 100px;">
                            {% if form.instance.photo %}
                                <img src="{{ form.instance.photo.url }}" class="rounded-circle" style="width: 100px; height: 100px; object-fit: cover;">
                            {% else %}
                                <i class="fas fa-camera fa-3x text-secondary opacity-25"></i>
                            {% endif %}
                        </div>
                        <h6 class="fw-bold">‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</h6>
                        <div class="mb-0">{{ form.photo }}</div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4 mb-4">
                    <div class="card-body text-center p-4">
                        <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                            <i class="fas fa-file-signature fa-2x text-secondary opacity-25"></i>
                        </div>
                        <h6 class="fw-bold">‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•</h6>
                        <div class="mb-2">{{ form.signature }}</div>
                        <small class="text-muted" style="font-size: 0.75rem;">(‡πÑ‡∏ü‡∏•‡πå .png ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏™)</small>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4 bg-primary bg-opacity-10">
                    <div class="card-header bg-transparent border-0 pt-3 pb-0">
                         <div class="form-check form-switch">
                            {{ form.create_user_account }}
                            <label class="form-check-label fw-bold text-primary" for="id_create_user_account">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Login)</label>
                        </div>
                    </div>
                    <div class="card-body" id="user-account-section">
                        <div class="mb-2">
                            <label class="small fw-bold text-muted">Username</label>
                            {{ form.username }}
                        </div>
                        <div class="mb-2">
                            <label class="small fw-bold text-muted">Password</label>
                            {{ form.password }}
                        </div>
                        <div class="mb-0">
                            <label class="small fw-bold text-muted">Email</label>
                            {{ form.email }}
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                
                <div class="card border-0 shadow-sm rounded-4 mb-4">
                    <div class="card-header bg-white py-3">
                        <h6 class="fw-bold m-0 text-dark">üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h6>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-3">
                            <div class="col-md-2">
                                <label class="form-label fw-bold">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</label>
                                {{ form.prefix }}
                            </div>
                            <div class="col-md-5">
                                <label class="form-label fw-bold">‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á</label>
                                {{ form.first_name }}
                            </div>
                            <div class="col-md-5">
                                <label class="form-label fw-bold">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                                {{ form.last_name }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</label>
                                {{ form.nickname }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">‡πÄ‡∏û‡∏®</label>
                                {{ form.gender }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</label>
                                {{ form.birth_date }}
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-bold">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô (ID Card)</label>
                                {{ form.id_card }}
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-bold">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                                {{ form.phone }}
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-bold">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label>
                                {{ form.address }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4 mb-4">
                    <div class="card-header bg-white py-3">
                        <h6 class="fw-bold m-0 text-success">üíº ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô & ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£</h6>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô <span class="text-danger">*</span></label>
                                {{ form.emp_type }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏†‡∏≤‡∏û</label>
                                {{ form.status }}
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
                                <div class="input-group">
                                    {{ form.position }}
                                    <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#modalPosition"><i class="fas fa-plus"></i></button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">‡πÅ‡∏ú‡∏ô‡∏Å</label>
                                <div class="input-group">
                                    {{ form.department }}
                                    <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#modalDepartment"><i class="fas fa-plus"></i></button>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                                {{ form.salary }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                                {{ form.start_date }}
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold text-primary">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°</label>
                                {{ form.social_security_id }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold text-primary">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</label>
                                {{ form.bank_account_no }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4 border-start border-4 border-warning">
                    <div class="card-header bg-warning bg-opacity-10 py-3">
                        <h6 class="fw-bold m-0 text-dark">üå≥ ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡∏° & ‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô (Sales)</h6>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label fw-bold text-primary">üëë ‡∏ú‡∏π‡πâ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (Upline)</label>
                                {{ form.introducer }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à</label>
                                {{ form.business_rank }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô (%)</label>
                                {{ form.commission_rate }}
                            </div>
                            
                            <div class="col-12"><hr class="text-muted"></div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ (‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏Ø)</label>
                                {{ form.bank_name }}
                            </div>
                            <div class="col-md-8">
                                <label class="form-label fw-bold">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏Ø)</label>
                                {{ form.bank_account }}
                            </div>
                        </div>

                        <div class="d-grid mt-4">
                            <button type="submit" class="btn btn-primary btn-lg rounded-pill shadow fw-bold">
                                <i class="fas fa-save me-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </form>
</div>

<div class="modal fade" id="modalPosition" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="text" id="new_position_title" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á..."></div><div class="modal-footer"><button class="btn btn-primary" onclick="savePosition()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div></div></div></div>
<div class="modal fade" id="modalDepartment" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ú‡∏ô‡∏Å</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="text" id="new_dept_name" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ú‡∏ô‡∏Å..."></div><div class="modal-footer"><button class="btn btn-primary" onclick="saveDepartment()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div></div></div></div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 1. Date Config
        const dateConfig = { dateFormat: "Y-m-d", altInput: true, altFormat: "d/m/Y", allowInput: true };
        flatpickr("#id_start_date", dateConfig);
        flatpickr("#id_birth_date", dateConfig);
        
        // 2. Toggle User
        const toggleUser = document.getElementById('id_create_user_account');
        const userSection = document.getElementById('user-account-section');
        function updateToggle() {
            if(toggleUser.checked) {
                userSection.style.display = 'block';
                userSection.querySelectorAll('input').forEach(i => i.required = true);
            } else {
                userSection.style.display = 'none';
                userSection.querySelectorAll('input').forEach(i => i.required = false);
            }
        }
        toggleUser.addEventListener('change', updateToggle);
        updateToggle();

        // ‚úÖ 3. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (UX: 50,000.00)
        const salaryInput = document.getElementById('input_salary');

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (‡πÉ‡∏™‡πà‡∏•‡∏π‡∏Å‡∏ô‡πâ‡∏≥)
        function formatMoney(amount) {
            if (!amount || amount === '') return '0.00';
            // ‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏ô‡πâ‡∏≥‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
            let num = parseFloat(amount.replace(/,/g, ''));
            if (isNaN(num)) return '0.00';
            // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÅ‡∏ö‡∏ö‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏ô‡πâ‡∏≥ ‡πÅ‡∏•‡∏∞‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏° 2 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
            return num.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }
        
        // 3.1 ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏°‡∏≤‡∏õ‡∏∏‡πä‡∏ö ‡∏à‡∏±‡∏î Format ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        salaryInput.value = formatMoney(salaryInput.value);

        // 3.2 ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å (Focus) -> ‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏ô‡πâ‡∏≥‡∏≠‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏á‡πà‡∏≤‡∏¢‡πÜ
        salaryInput.addEventListener('focus', function() {
            let val = this.value.replace(/,/g, ''); // ‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏ô‡πâ‡∏≥
            if (val === '0.00' || val === '0') {
                this.value = ''; // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô 0 ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏¥‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏•‡∏¢
            } else {
                this.value = val; // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏≠‡∏∑‡πà‡∏ô ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏•‡∏Ç‡∏î‡∏¥‡∏ö‡πÜ
            }
        });

        // 3.3 ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏≠‡∏≠‡∏Å (Blur) -> ‡πÉ‡∏™‡πà‡∏•‡∏π‡∏Å‡∏ô‡πâ‡∏≥‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
        salaryInput.addEventListener('blur', function() {
            if (this.value === '') {
                this.value = '0.00';
            } else {
                this.value = formatMoney(this.value);
            }
        });
    });

    // AJAX Functions (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
    function savePosition() {
        const title = document.getElementById('new_position_title').value;
        if(!title) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á");
        fetch("{% url 'api_create_position' %}", { method: "POST", headers: { "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value, "Content-Type": "application/x-www-form-urlencoded" }, body: "title=" + encodeURIComponent(title) })
        .then(r => r.json()).then(d => { if(d.status==='success') { const s = document.getElementById('id_position'); s.add(new Option(d.title, d.id, true, true)); bootstrap.Modal.getInstance(document.getElementById('modalPosition')).hide(); } });
    }
    function saveDepartment() {
        const name = document.getElementById('new_dept_name').value;
        if(!name) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ú‡∏ô‡∏Å");
        fetch("{% url 'api_create_department' %}", { method: "POST", headers: { "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value, "Content-Type": "application/x-www-form-urlencoded" }, body: "name=" + encodeURIComponent(name) })
        .then(r => r.json()).then(d => { if(d.status==='success') { const s = document.getElementById('id_department'); s.add(new Option(d.name, d.id, true, true)); bootstrap.Modal.getInstance(document.getElementById('modalDepartment')).hide(); } });
    }
</script>
{% endblock %}